#
# dobi.yaml - resources for building, testing, and developing dobi
#

meta:
    project: dobi
    default: all

#
# Mounts
#

mount=source:
    bind: .
    path: /go/src/github.com/dnephin/dobi

mount=dist:
    bind: ./dist/bin/
    path: /go/bin/

mount=projectdir:
    bind: .
    path: '{fs.projectdir}'

#
# Images
#

image=builder:
    image: dobi-dev
    context: dockerfiles/
    dockerfile: Dockerfile.build

image=linter:
    image: dobi-linter
    dockerfile: dockerfiles/Dockerfile.lint

image=dist-img:
    image: dnephin/dobi
    tags: ["{env.DOBI_VERSION}"]
    dockerfile: dockerfiles/Dockerfile.dist
    depends: [deps, binary]

image=releaser:
    image: dobi-release
    context: dockerfiles/
    dockerfile: Dockerfile.release

image=docs-img:
    image: dobi-docs-dev
    context: dockerfiles/
    dockerfile: Dockerfile.docs

image=docker-compose:
    image: dobi-test-examples
    dockerfile: Dockerfile.test-examples
    context: dockerfiles/


#
# Jobs
#

job=binary:
    use: builder
    artifact: ./dist/bin/
    mounts: [source, dist]
    command: script/build
    env:
      - "DOBI_BUILD_OS={env.DOBI_BUILD_OS:}"

job=watch:
    use: builder
    mounts: [source]
    command: script/watch
    interactive: true
    depends: [mocks]

job=shell:
    use: builder
    mounts: [source, dist]
    interactive: true
    provide-docker: true
    command: bash

job=test-unit:
    use: builder
    mounts: [source]
    command: "bash -c 'go test -v $(glide novendor)'"
    depends: [mocks]

job=lint:
    use: linter
    mounts: [source]

job=release:
    use: releaser
    mounts: [dist]
    env:
     - "GITHUB_TOKEN={env.GITHUB_TOKEN}"
     - "DOBI_VERSION={env.CIRCLE_TAG}"
    depends: [binary]

job=docs-build:
    use: docs-img
    artifact: ./docs/build/html
    mounts: [source]
    command: docs/script/build

job=docs-shell:
    use: docs-img
    mounts: [source]
    interactive: true
    command: bash

job=docs-watch:
    use: docs-img
    mounts: [source]
    interactive: true
    command: docs/script/watch

job=docs:
    use: docs-img
    mounts: [source]
    interactive: true
    command: docs/script/serve
    depends: ['docs-build']

job=mocks:
    use: builder
    mounts: [source]
    command: "bash -c 'go generate $(glide nv)'"

job=deps:
    use: builder
    mounts: [source]
    command: "glide install"
    sources: ['glide.yaml', 'glide.lock']
    artifact: vendor/

job=test-examples:
    use: docker-compose
    provide-docker: true
    interactive: true
    mounts: [projectdir, dist]
    entrypoint: script/test-examples
    working-dir: '{fs.projectdir}'
    depends: [binary]
    env:
      - 'APP_VERSION=testing'
      - 'DOCKER_API_VERSION={env.DOCKER_API_VERSION:}'
      - 'COMPOSE_API_VERSION={env.DOCKER_API_VERSION:}'

#
# Aliases
#

alias=test:
    tasks: [test-unit, test-examples]

alias=all:
    tasks: [lint, test, docs-build, binary]
